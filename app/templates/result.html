{% extends "base.html" %}
{% block content %}
<h1>Resultado</h1>

{% if job.status == "pending" %}
  <p class="muted"><span class="spinner"></span> Processando… esta página atualiza sozinha.</p>
  <script>
    const jobId = "{{ job_id }}";
    async function poll() {
      try {
        const res = await fetch(`/api/job/${jobId}`, { cache: "no-store" });
        const html = await res.text();
        if (res.status === 200 && !html.includes("Processando…")) {
          document.open(); document.write(html); document.close();
        } else {
          setTimeout(poll, 1200);
        }
      } catch(e) {
        setTimeout(poll, 1500);
      }
    }
    setTimeout(poll, 900);
  </script>
{% elif job.status == "error" %}
  <h3>Erro ao coletar</h3>
  <pre>{{ job.error }}</pre>
{% else %}
  {{ job.html | safe }}
{% endif %}
{% endblock %}
